<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Before you start · Wellcome ECA Remit Checker (Prototype)</title>

  <!-- Inter font for a clean, Wellcome-like look -->
  https://fonts.googleapis.com
  <link rel="preconnect" href="https://fonts.gstatic.com" crossoriginy=Inter:wght@400;600;700&display=swap

  <style>
    :root{ --bg:#ffffff; --ink:#111111; --muted:#4b5563; --link:#0b5cab;
      --border:#e5e7eb; --focus:#1d4ed8; --warn:#b45309; --good:#0f9960;
      --max:720px; --radius:8px; --gap:16px;
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);background:var(--bg)}
    a{color:var(--link)}
    .wrap{max-width:var(--max); margin:0 auto; padding:0 16px}
    header{padding:32px 0 20px; border-bottom:1px solid var(--border)}
    h1{font-size:32px; line-height:1.2; margin:0 0 6px; font-weight:700; letter-spacing:-0.01em}
    .lede{margin:0; color:var(--muted); font-size:16px}
    main{padding:24px 0}
    .block{display:block} .label{font-weight:600; margin-bottom:8px}
    textarea{width:100%; min-height:230px; resize:vertical; border:1px solid var(--border); border-radius:8px; padding:12px 14px; font:inherit}
    textarea:focus,select:focus,input:focus{ outline:3px solid rgba(29,78,216,.25); border-color:var(--focus) }
    fieldset{border:1px solid var(--border); border-radius:8px; padding:12px; margin-top:16px}
    legend{padding:0 6px; color:var(--muted); font-size:14px}
    .grid{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:760px){ .grid{grid-template-columns:1fr} }
    .actions{display:flex; gap:10px; margin-top:16px}
    .btn{appearance:none; border:1px solid #111; background:#111; color:#fff; border-radius:10px; padding:12px 16px; font-weight:700; cursor:pointer}
    .btn.ghost{ background:#fff; border:1px solid var(--border); color:var(--muted)}
    .guidance{margin-top:24px; background:#fff6b5; border:1px solid #f2e48a; border-radius:8px; padding:16px}
    .guidance h2{margin:0 0 8px; font-size:18px}
    .guidance p{margin:0 0 8px; color:#1f2937}
    .links{margin:8px 0 0; padding-left:18px}
    .links li{margin:4px 0}
    #results{margin-top:28px}
    #results h2{margin:0 0 10px; font-size:22px}
    .scorecards{display:grid; grid-template-columns:repeat(3,minmax(0,1fr)); gap:12px}
    @media (max-width:760px){ .scorecards{grid-template-columns:1fr} }
    .scorecard{border:1px solid var(--border); border-radius:8px; padding:12px; background:#fff}
    .score{font-weight:700; font-size:30px}
    .stack{display:flex; flex-direction:column; gap:8px}
    .bar{display:flex; align-items:center; gap:12px}
    progress{width:100%; height:10px}
    .cols{display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-top:12px}
    @media (max-width:760px){ .cols{grid-template-columns:1fr} }
    .panel{border:1px solid var(--border); border-radius:8px; padding:12px; background:#fff}
    .risks li{color:var(--warn)}
    .reasons, ul, ol{margin:8px 0 0; padding-left:18px}
    footer{border-top:1px solid var(--border); margin-top:28px; padding:14px 0}
    .tiny{font-size:12px; color:var(--muted)}
    .hidden{display:none}
    #toast{position:fixed;left:50%;top:18px;transform:translateX(-50%);
      background:#111;color:#fff;padding:10px 14px;border-radius:8px;z-index:9999;font-weight:600;box-shadow:0 6px 20px rgba(0,0,0,.2);display:none}
    .badge{display:inline-block; margin-left:8px; padding:3px 8px; font-size:12px; border:1px solid var(--border); border-radius:999px; color:#374151; background:#fafafa}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Before you start <span id="rulesBadge" class="badge">Ruleset loading…</span></h1>
      <p class="lede">
        Paste your proposal summary to check <strong>eligibility</strong> and <strong>Discovery Research remit</strong> fit for the Wellcome Early‑Career Award.
        This is a design prototype; results are heuristic, not a funding decision.
      </p>
    </div>
  </header>

  <main class="wrap">
    <form id="checkerForm" novalidate>
      <label class="block">
        <div class="label">Enter your proposal summary</div>
        <textarea id="summary" placeholder="Paste or type ~500–1,500 words describing aims, rationale, methods, expected knowledge gains, and key risks…"></textarea>
      </label>

      <fieldset>
        <legend>Quick eligibility & remit checklist</legend>
        <div class="grid">
          <label class="block">
            <div class="label">Career training</div>
            <select id="training">
              <option value="unknown" selected>Select…</option>
              <option value="phd">Completed PhD / higher research degree</option>
              <option value="equiv">No PhD, but ≥4 years’ equivalent research experience</option>
              <option value="none">Neither of the above</option>
            </select>
          </label>

          <label class="block">
            <div class="label">Postdoctoral experience (years)</div>
            <input type="number" id="postdocYears" min="0" step="0.1" placeholder="e.g., 1.5" />
          </label>

          <label class="block">
            <div class="label">Time on project (%)</div>
            <input type="number" id="timePct" min="0" max="100" step="1" placeholder="e.g., 80" />
          </label>

          <label class="block">
            <div class="label">Administering organisation</div>
            <select id="orgLoc">
              <option value="unknown" selected>Select…</option>
              <option value="uk">UK</option>
              <option value="roi">Republic of Ireland</option>
              <option value="lmics">Low-/middle‑income country</option>
              <option value="india">India (not eligible)</option>
              <option value="china">Mainland China (not eligible)</option>
              <option value="other">Other</option>
            </select>
          </label>

          <label class="block">
            <div class="label">Co‑applicants (ECA)</div>
            <select id="coapplicants">
              <option value="unknown" selected>Select…</option>
              <option value="no">No (lead applicant only)</option>
              <option value="yes">Yes (co‑applicants listed)</option>
            </select>
          </label>
        </div>

        <details class="details" style="margin-top:8px">
          <summary>Potential out‑of‑remit signals</summary>
          <div class="grid" style="margin-top:8px">
            <label class="block">
              <div class="label">Main aim is to test if an intervention works (e.g., large RCT)</div>
              <select id="trialFocus"><option>No</option><option>Yes</option></select>
            </label>
            <label class="block">
              <div class="label">Primary goal is diagnostic/treatment for clinical care</div>
              <select id="diagnosticFocus"><option>No</option><option>Yes</option></select>
            </label>
            <label class="block">
              <div class="label">Animal disease not relevant to humans</div>
              <select id="animalOut"><option>No</option><option>Yes</option></select>
            </label>
            <label class="block">
              <div class="label">Stand‑alone database/resource without research questions</div>
              <select id="standalone"><option>No</option><option>Yes</option></select>
            </label>
          </div>
        </details>
      </fieldset>

      <div class="actions">
        <button type="button" id="analyzeBtn" class="btn">Submit proposal summary</button>
        <button type="button" id="exportBtn" class="btn ghost">Export report (PDF)</button>
        <button type="button" id="resetBtn" class="btn ghost">Reset</button>
      </div>
    </form>

    <section class="guidance" aria-labelledby="how-it-works">
      <h2 id="how-it-works">How Wellcome grant funding works</h2>
      <p>Use these links to check scope, eligibility and conditions before you complete a full application.</p>
      <ul class="links">
        <li><a target="_blank" rel="noreferrer" href="https://wellcome.org/research-funding">Discovery Research remit (what we fund)</a></li>
        <li><a target="_blank" rel="noreferrer" href="https://wellcome.org/research-funding/schemes/wellcome-early-career-awards">Early‑Career Award (scheme page)</a></li>
        <li><a target="_blank" rel="noreferrer" href="https://wellcome.org/research-funding/guidance/policies-grant-conditionsli>
        <li><a target="_blank" rel="noreferrer" href="https://wellcome.org/research-funding">Early‑career researcher guidance</a></li>
      </ul>
      <p><strong>Need help?</strong> Contact Wellcome Funding Information Advisers via the “Contact us” links on the pages above.</p>
    </section>

    <section id="results" class="hidden" aria-live="polite">
      <h2>Results</h2>
      <div class="scorecards">
        <div class="scorecard">
          <h3>Eligibility</h3>
          <div class="score" id="eligScore">–</div>
          <ul id="eligReasons" class="reasons"></ul>
        </div>
        <div class="scorecard">
          <h3>Remit fit</h3>
          <div class="score" id="remitScore">–</div>
          <ul id="remitReasons" class="reasons"></ul>
        </div>
        <div class="scorecard">
          <h3>Assessment (50/25/25)</h3>
          <div class="stack">
            <div class="bar"><span>Proposal (50%)</span><progress id="propProg" max="100" value="0"></progress></div>
            <div class="bar"><span>Skills & experience (25%)</span><progress id="skillsProg" max="100" value="0"></progress></div>
            <div class="bar"><span>Research environment (25%)</span><progress id="envProg" max="100" value="0"></progress></div>
          </div>
          <ul id="assessNotes" class="reasons"></ul>
        </div>
      </div>

      <div class="cols">
        <div class="panel">
          <h3>Strengths</h3>
          <ul id="strengths"></ul>
        </div>
        <div class="panel">
          <h3>Risks</h3>
          <ul id="risks" class="risks"></ul>
        </div>
      </div>

      <div class="panel" style="margin-top:12px">
        <h3>Suggestions to tighten your summary</h3>
        <ol id="suggestions"></ol>
      </div>
    </section>
  </main>

  <footer>
    <div class="wrap tiny">
      <p>Prototype for product exploration. Rules summarised from Wellcome ECA & Discovery Research pages; not official guidance. No data leaves your browser.</p>
    </div>
  </footer>

  <div id="toast" role="status" aria-live="polite"></div>

  <!-- ===== BAKED-IN RULES distilled from your PDFs ===== -->
  <script>
    const RULES = {
      version: "Wellcome ECA · 2025-10",
      eligibility: {
        // Hard requirements / bans
        training: { // from ECA scheme page (completed PhD or ≥4y equiv)
          requireOneOf: ["phd","equiv"], weightFail: 50,
          cite: { src: "ECA scheme", note: "PhD or ≥4 years’ equivalent research experience" }
        },
        minTimePct: { value: 80, weightFail: 25, cite: { src: "ECA scheme", note: "≥80% research time" } },
        coApplicants: { accepted: false, weightFail: 25, cite: { src: "ECA scheme", note: "Co‑applicants not accepted" } },
        adminOrgAllowed: { allow: ["uk","roi","lmics"], ban: ["india","china"], weightFail: 100,
          cite: { src: "ECA scheme", note: "Admin org: UK/ROI/LMICs; not India or mainland China" }
        },
        transferBanChina: { active: true, weightFail: 100, cite: { src: "ECA scheme", note: "Cannot transfer funds into mainland China" } },
        // Soft cues
        maxPostdocYears: { value: 3, weightCaution: 10, cite: { src: "ECA scheme", note: ">3 years postdoc needs context" } }
      },
      remit: {
        base: 80,
        positives: [
          { phrase:"mechanism", weight:+5 },
          { phrase:"causal", weight:+4 },
          { phrase:"pathophysiology", weight:+4 },
          { phrase:"fundamental", weight:+3 },
          { phrase:"novel method", weight:+3 },
          { phrase:"conceptual framework", weight:+3 },
          { phrase:"tool" , weight:+2 },
          { phrase:"theoretical", weight:+2 },
          { phrase:"insight", weight:+2 },
          { phrase:"understanding", weight:+3 },
          { phrase:"hypothesis", weight:+2 },
          { phrase:"exploratory", weight:+2 },
          { phrase:"needs of communities", weight:+2 },
          { phrase:"social context", weight:+2 },
          { phrase:"historical context", weight:+2 },
          { phrase:"ethical context", weight:+2 }
        ],
        negatives: [
          { phrase:"randomized", weight:-15, note:"large trial/efficacy focus" },
          { phrase:"randomised", weight:-15, note:"large trial/efficacy focus" },
          { phrase:"phase ii", weight:-15, note:"efficacy trial" },
          { phrase:"phase iii", weight:-15, note:"efficacy trial" },
          { phrase:"multicentre trial", weight:-12 },
          { phrase:"clinical decision support", weight:-12 },
          { phrase:"diagnostic", weight:-12 },
          { phrase:"screening", weight:-10 },
          { phrase:"standalone database", weight:-10 },
          { phrase:"stand-alone database", weight:-10 },
          { phrase:"registry", weight:-8 },
          { phrase:"repository", weight:-8 },
          { phrase:"veterinary-only", weight:-15 },
          { phrase:"animal disease not relevant to humans", weight:-15 }
        ]
      }
    };
  </script>

  <!-- ===== Analysis logic using RULES ===== -->
  <script>
    const $ = id => document.getElementById(id);
    const analyzeBtn = $('analyzeBtn'), results = $('results'), exportBtn = $('exportBtn'), resetBtn = $('resetBtn');

    // small rules badge
    const badge = $('rulesBadge');
    if (badge) badge.textContent = `Ruleset: ${RULES.version}`;

    analyzeBtn.addEventListener('click', runAnalysis);
    exportBtn.addEventListener('click', () => window.print());
    resetBtn.addEventListener('click', () => { $('checkerForm').reset(); results.classList.add('hidden'); });

    function runAnalysis(){
      const summary = $('summary').value.trim();
      if (!summary) { $('summary').focus(); toast('Please paste a short proposal summary first.'); return; }

      const prev = analyzeBtn.textContent;
      analyzeBtn.disabled = true; analyzeBtn.textContent = 'Analysing…';
      try {
        // explicit inputs
        const training = $('training').value;  // unknown|phd|equiv|none
        const postdocYears = parseOrNaN($('postdocYears').value);
        const timePct = parseOrNaN($('timePct').value);
        const orgLoc = $('orgLoc').value;      // unknown|uk|roi|lmics|india|china|other
        const coapps = $('coapplicants').value;// unknown|no|yes

        const s = summary;

        // infer from text (to avoid "always eligible" when inputs unknown)
        const inferred = inferSignalsFromText(s);

        // ===== Eligibility (rule-driven) =====
        let elig = 100; const reasons = []; const need = [];

        // training
        if (training === 'unknown'){
          need.push('Career training');
        } else if (training === 'none'){
          elig -= RULES.eligibility.training.weightFail;
          reasons.push(reason(`${RULES.eligibility.training.cite.note} — not met`));
        }

        // postdoc soft caution
        if (!Number.isFinite(postdocYears)){
          if (inferred.postdocOver3){
            elig -= RULES.eligibility.maxPostdocYears.weightCaution;
            reasons.push(reason("Text suggests >3y postdoc – add context."));
          } else {
            need.push('Postdoctoral experience (years)');
          }
        } else if (postdocYears > RULES.eligibility.maxPostdocYears.value){
          elig -= RULES.eligibility.maxPostdocYears.weightCaution;
          reasons.push(reason(">3y postdoc – add context (breaks, part‑time, discipline change)."));
        }

        // time commitment
        if (!Number.isFinite(timePct)){
          if (inferred.timeUnder80){
            elig -= RULES.eligibility.minTimePct.weightFail;
            reasons.push(reason("Text implies <80% time on project — ECA expects ≥80%."));
          } else {
            need.push('Time on project (%)');
          }
        } else if (timePct < RULES.eligibility.minTimePct.value){
          elig -= RULES.eligibility.minTimePct.weightFail;
          reasons.push(reason("Commit at least 80% research time (≤20% other duties)."));
        }

        // admin org location
        const allowed = RULES.eligibility.adminOrgAllowed.allow;
        const banned  = RULES.eligibility.adminOrgAllowed.ban;
        if (orgLoc === 'unknown'){
          need.push('Administering organisation location');
          if (inferred.adminIndia){
            elig -= RULES.eligibility.adminOrgAllowed.weightFail;
            reasons.push(reason("Admin org appears in India — ineligible."));
          }
          if (inferred.adminChina){
            elig -= RULES.eligibility.adminOrgAllowed.weightFail;
            reasons.push(reason("Admin org appears in mainland China — ineligible."));
          }
        } else {
          if (banned.includes(orgLoc)){
            elig -= RULES.eligibility.adminOrgAllowed.weightFail;
            reasons.push(reason("Admin org in a restricted location (India or mainland China)."));
          } else if (!allowed.includes(orgLoc)){
            reasons.push(reason("Admin org location unclear for ECA — consider UK/ROI/LMICs."));
          }
        }

        // transfer ban (China)
        if (inferred.transferToChina){
          elig -= RULES.eligibility.transferBanChina.weightFail;
          reasons.push(reason("Proposal suggests transfer of funds into mainland China — ineligible."));
        }

        // co‑applicants
        if (coapps === 'unknown'){
          need.push('Co‑applicants (ECA)');
          if (inferred.coApplicantsLikely){
            elig -= RULES.eligibility.coApplicants.weightFail;
            reasons.push(reason("Text suggests co‑applicants/consortium — ECA is for a single lead applicant."));
          }
        } else if (coapps === 'yes'){
          elig -= RULES.eligibility.coApplicants.weightFail;
          reasons.push(reason("Co‑applicants not accepted for ECA."));
        }

        elig = clamp(elig);
        if (need.length && elig > 0) reasons.unshift(`Eligibility is provisional — please provide: ${need.join(', ')}.`);

        // ===== Remit (rule-driven) =====
        let remit = RULES.remit.base;
        const remitReasons = [];
        const lower = s.toLowerCase();

        // positives
        for (const p of RULES.remit.positives){
          if (lower.includes(p.phrase)) {
            remit += p.weight;
            remitReasons.push(`Positive remit cue: “${escapeHtml(p.phrase)}”.`);
          }
        }

        // negatives
        const negHits = [];
        for (const n of RULES.remit.negatives){
          if (lower.includes(n.phrase)){
            remit += n.weight;
            negHits.push(n);
            remitReasons.push(`
